flowchart TD
    %% ChaosLimbÄƒ Complete User/Model Input-Output Flow
    %% This visualization captures the entire AI ensemble and data flow
    
    %% User Input Layer
    A[ğŸ‘¤ User Input] --> B{Input Type Detection}
    
    subgraph UserInputs[User Input Methods]
        direction LR
        A1[ğŸ¤ Speech Recording]
        A2[âŒ¨ï¸ Text Input]
        A3[ğŸµ Audio Content]
        A4[ğŸ“– Text Content]
    end
    
    A --> UserInputs
    UserInputs --> B
    
    %% Intelligent Router (Component 8)
    B -->|Speech| C1[ğŸ§­ Router: Speech Path]
    B -->|Text| C2[ğŸ§­ Router: Text Path]
    
    %% Speech Processing Path (5 Components Active)
    subgraph SpeechPath[Speech Processing Pipeline]
        direction TB
        
        C1 --> D1[ğŸ”Š Component 1: Speech Recognition<br/>Whisper-Medium-Romanian<br/>Groq API - FREE]
        D1 --> D2[ğŸ—£ï¸ Component 2: Pronunciation Analysis<br/>Wav2Vec2-Romanian<br/>RunPod $2-3/mo]
        D1 --> D3[âœï¸ Component 3: Grammar Correction<br/>Fine-tuned mt5-small<br/>RunPod $3-5/mo]
        D2 --> E1[Phonological Score<br/>+ Stress Detection]
        D3 --> E2[Grammatical Score<br/>+ Error Classification]
        D3 --> F1[ğŸ§  Component 4: SPAM-A Semantic<br/>Sentence Transformers<br/>HF Inference - FREE]
        D2 --> G1[ğŸµ Component 7: SPAM-D Intonation<br/>Rule-based Stress Mapping<br/>In-app Logic - FREE]
        F1 --> H1[Semantic Similarity Score<br/>0-1 Scale]
        G1 --> I1[Intonation Warnings<br/>Stress Pattern Conflicts]
    end
    
    %% Text Processing Path (2 Components Active)
    subgraph TextPath[Text Processing Pipeline]
        direction TB
        
        C2 --> J1[âœï¸ Component 3: Grammar Correction<br/>Fine-tuned mt5-small<br/>RunPod $3-5/mo]
        J1 --> J2[Grammatical Score<br/>+ Error Classification]
        J1 --> K1[ğŸ§  Component 4: SPAM-A Semantic<br/>Sentence Transformers<br/>HF Inference - FREE]
        K1 --> K2[Semantic Similarity Score<br/>0-1 Scale]
    end
    
    %% Feedback Aggregator (Component 9)
    subgraph Aggregator[ğŸ”„ Component 9: Feedback Aggregator]
        direction TB
        
        L1[Input: Component Results] --> L2[Weighted Scoring System]
        L2 --> L3[Error Pattern Extraction]
        L3 --> L4[Unified Report Generation]
        
        %% Adaptive Weights by Input Type
        L2 --> L5{Input Type}
        L5 -->|Speech| L6[Grammar: 30%<br/>Pronunciation: 25%<br/>Semantic: 25%<br/>Intonation: 20%]
        L5 -->|Text| L7[Grammar: 50%<br/>Semantic: 50%]
    end
    
    %% Connect paths to Aggregator
    E1 & E2 & H1 & I1 --> Aggregator
    J2 & K2 --> Aggregator
    
    %% Error Garden Processing
    Aggregator --> M1[ğŸŒ± Error Garden Analysis]
    M1 --> M2[Pattern Clustering<br/>ML Algorithm]
    M2 --> M3[Fossilization Detection<br/>70% Threshold]
    M3 --> M4[Interlanguage Pattern Mapping]
    
    %% User Profile Database
    M4 --> N1[(ğŸ‘¤ User Profile DB)]
    N1 --> N2[Error History]
    N1 --> N3[Proficiency Tracking]
    N1 --> N4[Weakness Patterns]
    N1 --> N5[Learning Progress]
    
    %% Conversational AI (Component 10)
    subgraph ConversationalAI[ğŸ¤– Component 10: DeepSeek R1 Tutor]
        direction TB
        
        O1[Aggregated Report] --> O2[Context Formatting]
        O2 --> O3[Productive Confusion Engine]
        O3 --> O4[Personalized Feedback]
        O4 --> O5[Follow-up Questions]
        O5 --> O6[Error Explanations]
    end
    
    Aggregator --> ConversationalAI
    N1 --> ConversationalAI
    
    %% User Interface Features
    subgraph UIFeatures[ğŸ® ChaosLimbÄƒ Features]
        direction LR
        
        P1[ğŸŒ«ï¸ Deep Fog Mode<br/>Above-Level Immersion]
        P2[â° Chaos Window<br/>Randomized AI Sessions]
        P3[ğŸ“š Mystery Shelf<br/>User-Driven Vocab]
        P4[ğŸŒ» Error Garden<br/>Pattern Visualization]
        P5[ğŸ“Š Proficiency Tracker<br/>Progress Dashboard]
    end
    
    ConversationalAI --> UIFeatures
    N1 --> UIFeatures
    
    %% Feedback Loop to User
    UIFeatures --> Q[ğŸ“± User Interface]
    Q --> R[ğŸ‘¤ User Learning Experience]
    R --> A
    
    %% Post-MVP Components (Phased Rollout)
    subgraph FutureComponents[ğŸ”® Post-MVP Components]
        direction TB
        
        S1[ğŸ¯ Component 5: SPAM-B Relevance<br/>Text Summarization Model<br/>HF Inference - FREE<br/>Phase 2: Month 8-9]
        S2[ğŸŒ Component 6: SPAM-C Dialectal<br/>Fine-tuned BERT<br/>RunPod $2-3/mo<br/>Phase 3: Month 10-11]
    end
    
    %% Cost & Performance Indicators
    subgraph Metrics[ğŸ“Š System Metrics]
        direction LR
        
        T1[ğŸ’° Speech Path: ~$0.003-0.005/request<br/>1.0-1.5s processing]
        T2[ğŸ’° Text Path: ~$0.001-0.002/request<br/>0.5-0.8s processing]
        T3[ğŸ¯ MVP Total: $10-18/month<br/>7/10 components active]
        T4[ğŸ“ˆ Full System: $12-21/month<br/>10/10 components active]
    end
    
    %% Data Storage Layer
    subgraph Storage[ğŸ’¾ Storage Systems]
        direction LR
        
        U1[(ğŸ—„ï¸ Neon PostgreSQL<br/>User Data, Sessions, Errors)]
        U2[(â˜ï¸ Cloudflare R2<br/>Audio Recordings, Media)]
        U3[(ğŸ§  Memory Cache<br/>Similarity Scores, Sessions)]
    end
    
    %% Connect storage to main flow
    N1 --> U1
    A1 & A3 --> U2
    F1 & K1 --> U3
    
    %% Styling and Notes
    classDef userNode fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef aiNode fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef dbNode fill:#e8f5e8,stroke:#1b5e20,stroke-width:2px
    classDef featureNode fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef futureNode fill:#f5f5f5,stroke:#616161,stroke-width:2px,stroke-dasharray: 5 5
    
    class A,R,userNode
    class D1,D2,D3,F1,G1,J1,K1,O1,aiNode
    class N1,U1,U2,U3,dbNode
    class P1,P2,P3,P4,P5,featureNode
    class S1,S2,FutureComponents,futureNode
    
    %% Legend
    subgraph Legend[ğŸ“– Legend]
        direction TB
        
        L1[ğŸ‘¤ User Interaction]
        L2[ğŸ¤– AI Component]
        L3[ğŸ’¾ Data Storage]
        L4[ğŸ® User Feature]
        L5[ğŸ”® Future Component]
    end
    
    class L1,userNode
    class L2,aiNode
    class L3,dbNode
    class L4,featureNode
    class L5,futureNode

    %% Title and Description
    subgraph Title[ChaosLimbÄƒ: Complete User/Model Input-Output Flow]
        direction TB
        
        T1["AI-Native CALL Platform with 9-Component Ensemble"]
        T2["Structured Chaos Pedagogy: Error Harvesting + Productive Confusion"]
        T3["Real-time Adaptation based on Individual Interlanguage Patterns"]
    end
